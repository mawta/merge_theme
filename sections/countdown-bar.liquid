{% schema %}
{
  "name": "BFCM Countdown Bar",
  "settings": [
    {
      "type": "header",
      "content": "Giao diện chung"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Màu nền thanh bar",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Màu chữ thường",
      "default": "#FFFFFF"
    },
    {
      "type": "range",
      "id": "bar_font_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Cỡ chữ (Font Size)",
      "default": 14
    },
    {
      "type": "header",
      "content": "Cài đặt đồng hồ"
    },
    {
      "type": "color",
      "id": "timer_bg",
      "label": "Màu nền ô giờ",
      "default": "#8C231B"
    },
    {
      "type": "color",
      "id": "timer_text",
      "label": "Màu số đồng hồ",
      "default": "#FFFFFF"
    },
    {
      "type": "header",
      "content": "Nội dung thông báo"
    },
    {
      "type": "paragraph",
      "content": "Chia nội dung thành 3 phần để highlight phần giữa."
    },
    {
      "type": "text",
      "id": "msg_start",
      "label": "Văn bản đầu (Thường)",
      "default": "BFCM Week:"
    },
    {
      "type": "text",
      "id": "msg_bold",
      "label": "Văn bản nhấn mạnh (In Đậm)",
      "default": "20% OFF"
    },
    {
      "type": "color",
      "id": "highlight_color",
      "label": "Màu chữ nhấn mạnh",
      "default": "#FFFFFF"
    },
    {
      "type": "text",
      "id": "msg_end",
      "label": "Văn bản cuối (Thường)",
      "default": "Sitewide"
    },
    {
      "type": "header",
      "content": "Mã giảm giá"
    },
    {
      "type": "text",
      "id": "coupon_label",
      "label": "Text dẫn dắt",
      "default": "Use code:"
    },
    {
      "type": "text",
      "id": "coupon_code",
      "label": "Mã Code (In Đậm)",
      "default": "BFCM20"
    }
  ],
  "presets": [
    {
      "name": "BFCM Countdown Bar"
    }
  ]
}
{% endschema %}

{% style %}
  .bfcm-announcement-bar {
    background-color: {{ section.settings.bg_color }};
    color: {{ section.settings.text_color }};
    /* Dùng font-size từ settings */
    font-size: {{ section.settings.bar_font_size }}px;
    font-family: Arial, sans-serif;
    padding: 10px 20px;
    line-height: 1.5;
    position: relative;
    /* Tăng z-index của thanh bar lên cao để tránh bị header che */
    z-index: 1000;
  }

  /* Flex Container chính */
  .bfcm-bar-container {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap; 
    gap: 0; 
    max-width: 1400px;
    margin: 0 auto;
  }

  /* --- CÁC PHẦN TỬ CON --- */
  
  /* 1. ĐỒNG HỒ */
  .bfcm-timer-wrapper {
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: bold;
    order: 1; /* Desktop: Đứng đầu */
  }

  .timer-box {
    background-color: {{ section.settings.timer_bg }};
    color: {{ section.settings.timer_text }};
    padding: 2px 6px;
    border-radius: 4px;
    min-width: 2.2em; /* Độ rộng tương đối theo font-size */
    text-align: center;
    font-weight: bold;
    /* Giảm nhẹ font-size đồng hồ so với text chính cho đỡ thô */
    font-size: 0.9em; 
  }
  
  .timer-colon {
    font-weight: bold; 
    margin: 0 1px;
  }

  /* 2. TEXT THÔNG BÁO */
  .bfcm-message {
    /* Đổi về font-weight normal để chỉ đậm phần cần đậm */
    font-weight: 400; 
    /* CHỈNH SỬA: Bỏ margin phải, chỉ để margin trái để cách đồng hồ */
    margin: 0 0 0 15px; 
    order: 2; /* Desktop: Đứng giữa */
    text-align: center;
  }

  /* Class riêng cho phần in đậm (30% OFF) */
  .bfcm-highlight {
    font-weight: 800; /* Đậm hẳn */
    color: {{ section.settings.highlight_color }};
  }

  /* 3. MÃ CODE VÀ LABEL */
  .bfcm-coupon-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    position: relative;
    order: 4; /* Desktop: Đứng cuối */
  }

  /* Text "Use code:" để thường */
  .coupon-label {
    white-space: nowrap;
    font-weight: 400;
  }

  /* Mã Code in đậm */
  .bfcm-code {
    font-weight: 800;
    text-decoration: underline;
    /* Mã code luôn lấy màu highlight hoặc màu text chính nếu muốn nổi bật */
    color: {{ section.settings.highlight_color }};
  }
  
  /* ICON COPY */
  .copy-icon {
    width: 1.2em; /* Size icon theo font text */
    height: 1.2em;
    fill: {{ section.settings.text_color }};
    transition: transform 0.2s;
  }
  .bfcm-coupon-wrapper:active .copy-icon {
    transform: scale(0.9);
  }

  /* SEPARATORS (DẤU GẠCH ĐỨNG) */
  .bfcm-separator {
    opacity: 0.6;
    /* CHỈNH SỬA: Căn đều margin 2 bên 15px cho cân đối */
    margin: 0 15px;
    font-weight: 400;
  }
  
  .sep-desktop { display: inline-block; order: 3; }
  .sep-mobile { display: none; order: 3; }

  /* --- TOOLTIP COPY --- */
  .copy-tooltip {
    position: absolute;
    top: 130%;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    color: #000;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
    white-space: nowrap;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    /* Z-INDEX CAO ĐÈ LÊN TẤT CẢ */
    z-index: 99999;
  }
  .copy-tooltip::after {
    content: "";
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-width: 5px;
    border-style: solid;
    border-color: transparent transparent #fff transparent;
  }
  .copy-tooltip.show {
    opacity: 1;
    visibility: visible;
    top: 115%;
  }

  /* --- RESPONSIVE MOBILE --- */
  @media (max-width: 768px) {
    .bfcm-bar-container {
      padding: 5px 0;
    }

    /* Đưa TEXT lên dòng 1 */
    .bfcm-message {
      order: 1; 
      width: 100%; 
      /* Reset lại margin cho mobile */
      margin: 0 0 8px 0; 
      /* Mobile giảm nhẹ font-size 1 chút nếu setting quá to */
      font-size: 0.95em; 
    }

    /* Đưa ĐỒNG HỒ xuống dòng 2, bên trái */
    .bfcm-timer-wrapper {
      order: 2;
    }

    /* Hiện gạch đứng Mobile */
    .sep-mobile {
      display: inline-block;
      order: 3;
      margin: 0 8px;
    }
    
    /* Ẩn gạch đứng Desktop */
    .sep-desktop {
      display: none;
    }

    /* Đưa CODE xuống dòng 2, bên phải */
    .bfcm-coupon-wrapper {
      order: 4;
    }
  }
{% endstyle %}

<div class="bfcm-announcement-bar">
  <div class="bfcm-bar-container">
    
    <!-- 1. ĐỒNG HỒ -->
    <div class="bfcm-timer-wrapper" id="timer-{{ section.id }}">
      <span class="timer-box hours">23</span>
      <span class="timer-colon">:</span>
      <span class="timer-box minutes">59</span>
      <span class="timer-colon">:</span>
      <span class="timer-box seconds">59</span>
    </div>

    <!-- Dấu gạch đứng cho Mobile -->
    <span class="bfcm-separator sep-mobile">|</span>

    <!-- 2. TEXT THÔNG BÁO (Chia 3 phần) -->
    <div class="bfcm-message">
      {{ section.settings.msg_start }} 
      <span class="bfcm-highlight">{{ section.settings.msg_bold }}</span> 
      {{ section.settings.msg_end }}
    </div>

    <!-- Dấu gạch đứng cho Desktop -->
    <span class="bfcm-separator sep-desktop">|</span>

    <!-- 3. MÃ CODE & COPY -->
    <div class="bfcm-coupon-wrapper" onclick="copyToClipboard('{{ section.settings.coupon_code }}', this)">
      <span class="coupon-label">{{ section.settings.coupon_label }}</span>
      <span class="bfcm-code">{{ section.settings.coupon_code }}</span>
      
      <!-- Icon Copy -->
      <svg class="copy-icon" viewBox="0 0 24 24">
        <path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z"/>
      </svg>

      <span class="copy-tooltip">Copied!</span>
    </div>

  </div>
</div>

<script>
  (function() {
    const STORAGE_KEY = 'bfcm_timer_target';
    const DURATION = 24 * 60 * 60 * 1000; 
    const timerWrapper = document.getElementById('timer-{{ section.id }}');
    const elHours = timerWrapper.querySelector('.hours');
    const elMinutes = timerWrapper.querySelector('.minutes');
    const elSeconds = timerWrapper.querySelector('.seconds');

    function getTargetTime() {
      let target = localStorage.getItem(STORAGE_KEY);
      const now = new Date().getTime();
      if (!target || now > target) {
        target = now + DURATION;
        localStorage.setItem(STORAGE_KEY, target);
      }
      return parseInt(target);
    }

    function updateTimer() {
      const now = new Date().getTime();
      let target = getTargetTime();
      let distance = target - now;

      if (distance < 0) {
        localStorage.removeItem(STORAGE_KEY);
        target = getTargetTime();
        distance = target - now;
      }

      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);

      elHours.textContent = hours < 10 ? '0' + hours : hours;
      elMinutes.textContent = minutes < 10 ? '0' + minutes : minutes;
      elSeconds.textContent = seconds < 10 ? '0' + seconds : seconds;
    }

    updateTimer();
    setInterval(updateTimer, 1000);
  })();

  function copyToClipboard(text, element) {
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(text).then(() => {
        showTooltip(element);
      });
    } else {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        document.execCommand('copy');
        showTooltip(element);
      } catch (err) {
        console.error('Unable to copy', err);
      }
      document.body.removeChild(textArea);
    }
  }

  function showTooltip(element) {
    const tooltip = element.querySelector('.copy-tooltip');
    tooltip.classList.add('show');
    setTimeout(() => {
      tooltip.classList.remove('show');
    }, 2000);
  }
</script>