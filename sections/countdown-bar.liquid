{% schema %}
{
  "name": "BFCM Countdown Bar",
  "settings": [
    {
      "type": "header",
      "content": "Giao diện chung"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Màu nền thanh bar",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Màu chữ thường",
      "default": "#FFFFFF"
    },
    {
      "type": "range",
      "id": "bar_font_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Cỡ chữ (Font Size)",
      "default": 14
    },
    {
      "type": "header",
      "content": "Cài đặt đồng hồ"
    },
    {
      "type": "paragraph",
      "content": "Chọn mốc thời gian muốn đếm ngược tới hàng ngày."
    },
    {
      "type": "range",
      "id": "end_hour",
      "min": 0,
      "max": 23,
      "step": 1,
      "label": "Giờ kết thúc (0-23h)",
      "default": 23
    },
    {
      "type": "range",
      "id": "end_minute",
      "min": 0,
      "max": 59,
      "step": 1,
      "label": "Phút kết thúc (0-59p)",
      "default": 59
    },
    {
      "type": "color",
      "id": "timer_bg",
      "label": "Màu nền ô giờ",
      "default": "#8C231B"
    },
    {
      "type": "color",
      "id": "timer_text",
      "label": "Màu số đồng hồ",
      "default": "#FFFFFF"
    },
    {
      "type": "header",
      "content": "Nội dung thông báo"
    },
    {
      "type": "paragraph",
      "content": "Chia nội dung thành 3 phần để highlight phần giữa."
    },
    {
      "type": "text",
      "id": "msg_start",
      "label": "Văn bản đầu (Thường)",
      "default": "BFCM Week:"
    },
    {
      "type": "text",
      "id": "msg_bold",
      "label": "Văn bản nhấn mạnh (In Đậm)",
      "default": "20% OFF"
    },
    {
      "type": "color",
      "id": "highlight_color",
      "label": "Màu chữ nhấn mạnh",
      "default": "#FFFFFF"
    },
    {
      "type": "text",
      "id": "msg_end",
      "label": "Văn bản cuối (Thường)",
      "default": "Sitewide"
    },
    {
      "type": "header",
      "content": "Mã giảm giá"
    },
    {
      "type": "text",
      "id": "coupon_label",
      "label": "Text dẫn dắt",
      "default": "Use code:"
    },
    {
      "type": "text",
      "id": "coupon_code",
      "label": "Mã Code (In Đậm)",
      "default": "BFCM20"
    }
  ],
  "presets": [
    {
      "name": "BFCM Countdown Bar"
    }
  ]
}
{% endschema %}

{% style %}
  .bfcm-announcement-bar {
    background-color: {{ section.settings.bg_color }};
    color: {{ section.settings.text_color }};
    font-size: {{ section.settings.bar_font_size }}px;
    font-family: Arial, sans-serif;
    padding: 10px 20px;
    line-height: 1.5;
    position: relative;
    z-index: 1000;
  }

  /* Flex Container chính */
  .bfcm-bar-container {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap; 
    gap: 0; 
    max-width: 1400px;
    margin: 0 auto;
  }

  /* --- CÁC PHẦN TỬ CON --- */
  
  /* 1. ĐỒNG HỒ */
  .bfcm-timer-wrapper {
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: bold;
    order: 1; /* Desktop: Đứng đầu */
  }

  .timer-box {
    background-color: {{ section.settings.timer_bg }};
    color: {{ section.settings.timer_text }};
    padding: 2px 6px;
    border-radius: 4px;
    min-width: 2.2em;
    text-align: center;
    font-weight: bold;
    font-size: 0.9em; 
  }
  
  .timer-colon {
    font-weight: bold; 
    margin: 0 1px;
  }

  /* 2. TEXT THÔNG BÁO */
  .bfcm-message {
    font-weight: 400; 
    margin: 0 0 0 15px; 
    order: 2; /* Desktop: Đứng giữa */
    text-align: center;
  }

  .bfcm-highlight {
    font-weight: 800;
    color: {{ section.settings.highlight_color }};
  }

  /* 3. MÃ CODE VÀ LABEL */
  .bfcm-coupon-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    position: relative;
    order: 4; /* Desktop: Đứng cuối */
  }

  .coupon-label {
    white-space: nowrap;
    font-weight: 400;
  }

  .bfcm-code {
    font-weight: 800;
    text-decoration: underline;
    color: {{ section.settings.highlight_color }};
  }
  
  /* ICON COPY */
  .copy-icon {
    width: 1.2em;
    height: 1.2em;
    fill: {{ section.settings.text_color }};
    transition: transform 0.2s;
  }
  .bfcm-coupon-wrapper:active .copy-icon {
    transform: scale(0.9);
  }

  /* SEPARATORS */
  .bfcm-separator {
    opacity: 0.6;
    margin: 0 15px;
    font-weight: 400;
  }
  
  .sep-desktop { display: inline-block; order: 3; }
  .sep-mobile { display: none; order: 3; }

  /* --- TOOLTIP COPY --- */
  .copy-tooltip {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    color: #000;
    font-weight: bold;
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 12px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease-in-out;
    white-space: nowrap;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    z-index: 99999;
    pointer-events: none;
  }
  .copy-tooltip::after { display: none; }
  .copy-tooltip.show {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1.1);
  }

  /* --- RESPONSIVE MOBILE --- */
  @media (max-width: 768px) {
    .bfcm-bar-container { padding: 5px 0; }
    .bfcm-message { order: 1; width: 100%; margin: 0 0 8px 0; font-size: 0.95em; }
    .bfcm-timer-wrapper { order: 2; }
    .sep-mobile { display: inline-block; order: 3; margin: 0 8px; }
    .sep-desktop { display: none; }
    .bfcm-coupon-wrapper { order: 4; }
  }
{% endstyle %}

<div class="bfcm-announcement-bar">
  <div class="bfcm-bar-container">
    
    <div class="bfcm-timer-wrapper" id="timer-{{ section.id }}">
      <span class="timer-box hours">--</span>
      <span class="timer-colon">:</span>
      <span class="timer-box minutes">--</span>
      <span class="timer-colon">:</span>
      <span class="timer-box seconds">--</span>
    </div>

    <span class="bfcm-separator sep-mobile">|</span>

    <div class="bfcm-message">
      {{ section.settings.msg_start }} 
      <span class="bfcm-highlight">{{ section.settings.msg_bold }}</span> 
      {{ section.settings.msg_end }}
    </div>

    <span class="bfcm-separator sep-desktop">|</span>

    <div class="bfcm-coupon-wrapper" onclick="copyToClipboard('{{ section.settings.coupon_code }}', this)">
      <span class="coupon-label">{{ section.settings.coupon_label }}</span>
      <span class="bfcm-code">{{ section.settings.coupon_code }}</span>
      <svg class="copy-icon" viewBox="0 0 24 24">
        <path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z"/>
      </svg>
      <span class="copy-tooltip">Copied!</span>
    </div>

  </div>
</div>

<script>
  (function() {
    // Lấy giá trị giờ và phút từ settings của đại kaaa
    const settingHour = {{ section.settings.end_hour }};
    const settingMinute = {{ section.settings.end_minute }};

    const timerWrapper = document.getElementById('timer-{{ section.id }}');
    const elHours = timerWrapper.querySelector('.hours');
    const elMinutes = timerWrapper.querySelector('.minutes');
    const elSeconds = timerWrapper.querySelector('.seconds');

    function updateTimer() {
      const now = new Date();
      // Tạo một đối tượng Date mới cho thời gian đích trong ngày hôm nay
      let targetDate = new Date();
      targetDate.setHours(settingHour, settingMinute, 0, 0);

      // Nếu thời gian đích đã qua (ví dụ bây giờ 12h, đích là 9h sáng),
      // thì đích sẽ là 9h sáng NGÀY MAI.
      if (now.getTime() > targetDate.getTime()) {
        targetDate.setDate(targetDate.getDate() + 1);
      }

      const distance = targetDate.getTime() - now.getTime();

      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);

      elHours.textContent = hours < 10 ? '0' + hours : hours;
      elMinutes.textContent = minutes < 10 ? '0' + minutes : minutes;
      elSeconds.textContent = seconds < 10 ? '0' + seconds : seconds;
    }

    updateTimer();
    setInterval(updateTimer, 1000);
  })();

  function copyToClipboard(text, element) {
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(text).then(() => showTooltip(element));
    } else {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        document.execCommand('copy');
        showTooltip(element);
      } catch (err) {
        console.error('Unable to copy', err);
      }
      document.body.removeChild(textArea);
    }
  }

  function showTooltip(element) {
    const tooltip = element.querySelector('.copy-tooltip');
    tooltip.classList.add('show');
    setTimeout(() => {
      tooltip.classList.remove('show');
    }, 2000);
  }
</script>